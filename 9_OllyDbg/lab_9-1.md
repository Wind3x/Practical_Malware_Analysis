# Answers to Questions that Took Forever 

1. How can you get this malware to install itself?

> Run the malware with the -in option followed by the password 'abcd' or patch the file to bypass the password check.

2. What are the command-line options for this program? What is the password requirement?

> Command line options include -in for install, -re for remove, -c for updating the configuration, and -cc for clearing the configuration in the registry. The password is 'abcd'. 

3. How can you use OllyDbg to permanently patch this malware, so that it doesnâ€™t require the special command-line password?

> Overwriting the beginning of the function responsible for doing the password check with instructions to set EAX to 1 and then return allows this function to execute and always return 1 in order for the rest of the program to continue executing. 

4. What are the host-based indicators of this malware?

> * File: %SYSTEMROOT%\system32\\\<filename\>
> * Registry entry: SOFTWARE\Microsoft \XPS\Configuration
> * Service: \<filename\> Manager Service 

5. What are the different actions this malware can be instructed to take via the network?

> UPLOAD (downloads data), DOWNLOAD (uploads data), CMD (runs a command and outputs to C2), NOTHING (does nothing), and SLEEP (sleeps).

6. Are there any useful network-based signatures for this malware?

> * http://practicalmalwareanalysis[.]com
> * HTTP requests with randomly generated URI patterns of the format xxxx/xxxx.xxx and minimal headers.
> * C2 payloads containing \`,\`,\` and ,\`,\`,

## Notes

Interesting strings

> * command.com
> * COMSPEC
> * SOFTWARE\Microsoft \XPS
> * NOTHING
> * CMD
> * DOWNLOAD
> * UPLOAD
> * SLEEP
> * cmd.exe
> * /c del
> * http://www.practicalmalwareanalysis[.]com

Imports

> * Files, registry, services
> * Sleep
> * Network stuff

Dynamic

> * Checks for a command line argument, if none, checks for the existence of registry key "SOFTWARE\Microsoft \XPS\Configuration", if that doesn't exist the malware deletes itself by calling ShellExecuteA with cmd.exe /c del \<path\_to\_malware\> >> NUL
> * If the key does exist, the malware runs a command, sleeps, and then loops. It appears that the command to be run is fetched with the function at 0x401AF0 which crafts an HTTP request using a randomly generated URI (ex. BL5j/MOuR.8Oq) and minimal headers from http://www.practicalmalwareanalysis[.]com.
> * Commands consist of SLEEP, UPLOAD, DOWNLOAD, CMD, and NOTHING. The UPLOAD command calls CreateFileA, recv, and WriteFileA in order to receive data from a network resource and write it to disk. The DOWNLOAD command calls ReadFile and send in order to send data to a network resource. The NOTHING command does nothing, the SLEEP command accepts a number of seconds to sleep for and calls the Sleep function. CMD parses the command to be executed with cmd.exe and then sends the output back to the command and control infrastructure.
> *  If provided a command line argument, the malware still deletes itself. Looking closer, the malware appears to take the last argument passed in and perform some checks against it, possibly looking for a password or valid instruction. Patching this function to always return 1 (success) allows us to bypass the password check, and then the malware still deletes itself.
> * A follow-up check for 2 arguments being passed in is what's taking the exit route, so passing in another argument allows us to move forward down the 'success' route. Looking at IDA, it appears the malware checks for the first argument being "-in, -re, -c, or -cc". Following the path for the -in option, the code checks for 2 user-passed arguments or 3. If only 2, the malware creates a service using the base name of the malware executable, if 3 arguments the third is used as the service name. Following along in Olly, the service is created using the binary path %SYSTEMROOT%\system32\\\<filename\>. 
> * Following the service creation, the malware finds the location of kernel32.dll and opens it, getting the write, access, and creation times associated with kernel32.dll. It then opens the executable \<filename\> previously created in system32 and sets its time attributes to those retrieved from the kernel32.dll. 
> * Finally, the malware creates a registry key of "SOFTWARE\Microsoft \XPS\Configuration using values 60, 80, "ups", and "http://www.practicalmalwareanalysis[.]com" indicating network functionality.
> * Following the other paths in IDA, it's easy to see that the -re option does the opposite of the -in option, deleting the file from system32, deleting the service, and zeroes out the Configuration registry key.
> * The -c option takes a total of 6 argument, the flag (-c) plus the 'password' (random since we patched) and 4 other arguments and updates the Configuration key with the parameters passed in.
> * The -cc option only requires itself as the flag, plus the 'password' to be passed in. Stepping through this functionality in Olly we can see a format string passed around and that the Configuration value is accessed. Checking the console for the debugged program, we can see that the values were read from the Configuration value and formatted then printed to the console.
