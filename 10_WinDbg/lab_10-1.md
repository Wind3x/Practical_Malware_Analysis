# Answers to Questions that Took Forever 

1. Does this program make any direct changes to the registry? (Use procmon to check.)

> Using procmon, there do not appear to have been any changes made to the registry by the malware. Regshot shows some changes to firewall- and service-related keys.

2. The user-space program calls the ControlService function. Can you set a breakpoint with WinDbg to see what is executed in the kernel as a result of the call to ControlService?

> Investigating the executable in IDA shows the ControlService function called at 0x401080. Setting a breakpoint here in the guest's WinDbg will halt execution before the user-space program calls ControlService to unload the kernel module. Viewing the loaded driver object from the host's WinDbg, there are no device objects associated with the driver object and the kernel module is therefore not accessible from user-space. 

> Setting a breakpoint on the unload function listed in the driver object structure at DriverUnload (+0x034) and resuming execution in the guest debugger, we can see that the breakpoint is hit at Lab10\_01+0x486, giving us the relative offset of the unload function from the beginning of the file. Using this offset to navigate to the same place in IDA Pro, observe four calls to RtlCreateRegistryKey followed by two calls to RtlWriteRegistryValue. These calls set the EnableFirewall value to 0 in both the Standard and Domain profiles of Windows Firewall. 

3. What does this program do?

> This program loads a kernel driver as a service, which disables the Windows Firewall from kernel space and then unloads immediately. 

## Notes

Static

> * ControlService, Start/Open/CreateService, OpenSCManager
> * GetModuleHandle, GetModuleFileName
> * WriteFile
> * GetProcAddress, LoadLibrary
> * C:\Windows\System32\Lab10-01.sys
> * File, Exit, Help, About, System
> * RegWriterApp Version 1.0
> * Hello World!
> * REGWRITERAPP

> * EnableFirewall
> * \Registry\Machine\SOFTWARE\Policies\Microsoft\WindowsFirewall\StandardProfile
> * \Registry\Machine\SOFTWARE\Policies\Microsoft\WindowsFirewall\Domain Profile
> * \Registry\Machine\SOFTWARE\Policies\Microsoft\WindowsFirewall
> * \Registry\Machine\SOFTWARE\Policies\Microsoft
> * c:\winddk\7600.16385.1\src\general\regwriter\wdm\sys\objfre\_wxp\_x86\i386\sioctl.pdb
> * RtlWriteRegistryValue, RtlCreateRegistryKey
> * ntoskrnl.exe
> * Windows (R) Win 7 DDK provider
> * Important System Driver

> * IDA shows the service will be named Lab10-01 and use the .sys file

Dynamic

> * No process created on run?
> * No visible changes to registry via procmon, but regshot shows modifications to many of the keys seen in the strings output and in services-related keys.
