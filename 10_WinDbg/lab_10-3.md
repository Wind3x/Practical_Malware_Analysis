# Answers to Questions that Took Forever 

1. What does this program do?

> The user-space executable opens an instance of Internet Explorer to http://www.malwareanalysisbook.com/ad.html every 30 seconds.
> * Creates a service "Process Helper" using C:\Windows\System32\Lab10-03.sys and starts it.
> * Creates a handle to the device using CreateFile for "\\\\\\\\.\\\\ProcHelper".
> * Sends an I/O request to the device using DeviceIoControl with an IoControlCode of 0xABCDEF01 (but no input or output buffers for sending or receiving data to/from the driver.
> * Opens the Internet Explorer application using CoCreateInstance with a CLSID of 0x2DF01 to initialize a COM object which is then called in a loop that call the interface with the URL as a parameter, then sleeps for 30 seconds.

2. Once this program is running, how do you stop it?

> I successfully used Process Explorer to kill the iexplorer process created by the user-space executable. The executable does not have persistence mechanisms in place to continue execution after a reboot, so rebooting or reverting the VM would also work.

3. What does the kernel component do?

> The kernel component unlists the requesting process from the process list, making it invisible to a user.
> * Creates a device for user-space interaction with a call to IoCreateDevice at "\\\\Device\\\\ProcHelper" and creates a symbolic link to the device using IoCreateSymbolicLink at "\\\\DosDevices\\\\ProcHelper".
> * A call to DeviceIoControl will call a driver function to remove the current process from the process list.
> * On unload, a call to IoDeleteSymbolicLink removes the link to the device, followed by a call to IoDeleteDevice to remove the device entirely.

## Notes

Static

> * Sleep
> * DeviceIoControl
> * CreateFileA/WriteFile
> * Start/CreateServiceA
> * LoadLibraryA
> * http://www.malwareanalysisbook.com/ad.html
> * \\\\.\\ProcHelper
> * \DosDevices\ProcHelper
> * \Device\ProcHelper
> * IoGetCurrentProcess
> * C:\Windows\System32\Lab10-03.sys

> * Executable creates service "Process Helper" as a SERVICE\_KERNEL\_DRIVER using C:\\\\Windows\\\\System32\\\\Lab10-03.sys
> * Executable then creates a file at \\\\\\\\.\\\\ProcHelper in order to retrieve a handle to the device. 
> * Using this device, the executable calls DeviceIoControl with an IoControlCode of 0x0ABCDEF01. 
> * The executable the initializes a COM object with a CLSID of 0x02DF01 (Internet Explorer) and opens a browser windows to http://www.malwareanalysisbook.com/ad.html before sleeping for 30 seconds and repeating. 

> * The kernel driver calls IoCreateDevice to create the \\\\Device\\\\ProcHelper device as type FILE\_DEVICE\_UNKNOWN
> * The kernel driver then creates a symbolic link to the device and deletes the device.

Dynamic

> * Repeated HTTP requests to www.malwareanalysisbook.com/ad.html using the browser's user agent string. 
> * The MFT for the driver is mostly IopInvalidDeviceRequest functions, except for three locations (two of which are the same). The first two locations are a function that calls IofCompleteRequest. The last location is a function that calls IoGetCurrentProcess, grabs the pointers to the previous and next processes in the list and overwrites each to point to the other, effectively removing the current process from the process list.

