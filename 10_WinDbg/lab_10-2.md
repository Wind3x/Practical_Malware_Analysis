# Answers to Questions that Took Forever 

1. Does this program create any files? If so, what are they?

> IDA shows calls to CreateFileA with paths of:
> * C:\\\\Windows\\\\System32\\\\Mlwx486.sys

2. Does this program have a kernel component?

> Creates a service with a DisplayName of 486 WS Driver using the file created in C:\\\\Windows\\\\System32\\\\Mlwx486.sys

3. What does this program do?

> Copies a PE file from it's .rsrc section into C:\\\\Windows\\\\System32\\\\Mlwx486.sys and loads the kernel module as the service "486 WS Driver". The kernel module is a rootkit that removes Mlwx486.sys from directory listings by hooking the NtQueryDirectoryFile function in the System Service Descriptor Table and modifying it.

## Notes

Static

> WriteFile
> CreateFileA
> FindResourceA
> LoadResource
> Start/CreateServiceA
> GetProcAddress
> LoadLibraryA
> 486 WS Driver
> C:\Windows\System32\Mlwx486.sys
> c:\winddk\7600.16385.1\src\general\rootkit\wdm\sys\objfre\_wxp\_x86\i386\sioctl.pdb
> KeServiceDescriptorTable
> NtQueryDirectoryFile
> MmGetSystemRoutineAddress
> Sample IOCTL Driver
> SIOCTL.sys

> Resource hacker shows a PE header in the .rsrc section, as does PEview, investigating w/ IDA shows it to match what is written to Mlwx486.sys on disk.

Dynamic

> Comparing the SSDT entry for offset nt!KiServiceTable+0x240 before and after running the executable shows a change from 0x8056f266 to 0xba71b486 (outside the bounds of the ntoskrnl module). Running `ln 8056f266` shows us that the overwritten entry pointed to the NtQueryDirectoryFile function, which matches up with the string found during static analysis.

> Examining the kernel module in IDA shows that it performs a call to NtQueryDirectoryFile, but modifies the output if the FileInformationClass parameter is 3, if the return value from the call to NtQueryDirectoryFile is non-negative, and the file being passed begins with "Mlwx". If the file begins with Mlwx, the malicious code changes the pointer to the file beginning with Mlwx to point to whatever is after it, ensuring it is skipped in any directory listings. 
