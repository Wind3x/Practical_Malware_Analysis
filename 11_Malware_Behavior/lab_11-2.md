# User-space answers to user-space problems

1. What are the exports for this DLL malware?

> The .dll contains a single export in its Export Address Table, called "installer".

2. What happens after you attempt to install this malware using rundll32.exe?

> The malicious DLL copies itself to \System32\spoolvxx32.dll and adds this path to the AppInit DLLs key in the registry.

3. Where must Lab11-02.ini reside in order for the malware to install properly?

> \Windows\System32\

4. How is this malware installed for persistence?

> The 'installer' function exported by the .dll adds \Windows\System32\spoolvxx32.dll to SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows\AppInit\_DLLs, ensuring that the spoolvxx32.dll is loaded into every process that loads User32.dll. The malicious DLL then copies itself to that location.

5. What user-space rootkit technique does this malware employ?

> Inline hooking of the `send` function from wsock32.dll.

6. What does the hooking code do?

> Checks for the string "RCPT TO: <" and, if present, adds a second occurrence of "RCPT TO: " with a malicious email address.

7. Which process(es) does this malware attack and why?

> Email client processes "OUTLOOK.exe", "MSIMN.exe", and "THEBAT.exe" to export emails containing "RCPT TO: <" by adding a second recipient to each email as it is sent.

8. What is the significance of the .ini file?

> Used to hold an encrypted email address that is decrypted during runtime.

9. How can you dynamically capture this malwareâ€™s activity with Wireshark?

> Set up a fake mail server, install the malware, and generate fake emails to be sent while running Wireshark.


## Notes

Static

> * CreateToolhelp32Snapshot
> * Create/CopyFile
> * LoadLibrary
> * GetCurrentThreadID, ResumeThread, SuspendThread, Thread32First, Thread32Next
> * RegOpen/CloseKey/SetValue
> * THEBAT.EXE //mail client
> * OUTLOOK.EXE //mail client
> * MSIMN.EXE //mail client
> * RCPT TO:
> * send, wsock32.dll
> * SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows
> * spoolvxx32.dll
> * AppInit\_DLLs

> * Function 0x10001203 changes the virtual protection for an address to RWX, modifies it, and then changes the protection back. Seen previously w/ Linux rootkit demo. The 'send' function from wsock32.dll appears to be the targeted function.

Dynamic

> * Used OllyDbg to get full path to .ini file and to call the exported "install" function to verify that the .dll was copying itself to the persistent DLL.

> * Setting a breakpoint after what looks like a decoding function (expected since the data in the .ini file seemed to be an encoded string) reveals a string in EAX of "billy@malwareanalysisbook.com". 
